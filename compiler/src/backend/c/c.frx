import "../../frontend/core/namespace.frx";
import "../../frontend/syntax/program.frx";

export enum TranspilerMode : u8
{
    TRANSPILER_MODE_MACROS,
    TRANSPILER_MODE_ENUMS,
    TRANSPILER_MODE_STRUCT_DECL,
    TRANSPILER_MODE_FUNC_DECL,
    TRANSPILER_MODE_GLOBAL_VARS,
    TRANSPILER_MODE_STRUCT_IMPL,
    TRANSPILER_MODE_FUNC_IMPL,

    TRANSPILER_MODE_COUNT
}

export struct Transpiler
{
    TranspilerMode mode;
    FILE* file;

    Namespace* current_namespace;
}

export i32 c_generate_code(ASTProgram* program)
{
    Transpiler transpiler;
    transpiler.file = fopen("/tmp/output.c", "w");

    if(transpiler.file == nullptr)
    {
        return 1;
    }

    transpiler.current_namespace = nullptr;

    fprintf(transpiler.file, "#include <stddef.h>\n");
    fprintf(transpiler.file, "#include <stdint.h>\n");

    fprintf(transpiler.file, "typedef size_t usize;\n");
    fprintf(transpiler.file, "typedef int64_t isize;\n");
    fprintf(transpiler.file, "typedef int8_t i8;\n");
    fprintf(transpiler.file, "typedef int16_t i16;\n");
    fprintf(transpiler.file, "typedef int32_t i32;\n");
    fprintf(transpiler.file, "typedef int64_t i64;\n");
    fprintf(transpiler.file, "typedef uint8_t u8;\n");
    fprintf(transpiler.file, "typedef uint16_t u16;\n");
    fprintf(transpiler.file, "typedef uint32_t u32;\n");
    fprintf(transpiler.file, "typedef uint64_t u64;\n");
    fprintf(transpiler.file, "typedef u8 b8;\n");
    fprintf(transpiler.file, "typedef u16 b16;\n");
    fprintf(transpiler.file, "typedef u32 b32;\n");
    fprintf(transpiler.file, "typedef u64 b64;\n");
    fprintf(transpiler.file, "typedef float f32;\n");
    fprintf(transpiler.file, "typedef double f64;\n\n");

    transpile_program(&transpiler, program);

    fclose(transpiler.file);

    Config* config = get_config();

    char[4096] command;
    strcpy(command, "gcc /tmp/output.c -o ");
    strcat(command, config->output);

    usize i;
    for(i = 0; i < list_size(&config->link_targets); i = i + 1)
    {
        char* link_target = list_get(&config->link_targets, i);
        strcat(command, " ");
        strcat(command, link_target);
    }

    return system(command);
}
