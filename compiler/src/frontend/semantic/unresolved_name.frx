import "ast.frx";
import "../core/parser.frx";
import "../syntax/unresolved_name.frx";

export void analyze_unresolved_name(Parser* parser,
    ASTUnresolvedName* unresolved_name, AST* ast)
{
    assert(parser != nullptr);

    assert(unresolved_name != nullptr);

    Namespace* ns = parser->current_namespace;
    char* name = unresolved_name->name;
    Scope* scope = unresolved_name->scope;

    VarSymbol* var_symbol = var_table_find_by_scope(&parser->var_table, scope,
        name);

    b8 is_var = var_symbol != nullptr;

    b8 is_ambiguous = false;
    b8 resolved = is_var;

    if(is_ambiguous)
    {
        //FIXME: Print the correct location, this is only a placeholder
        SourceLocation loc;
        error_ambiguous_unresolved_name(parser_source_file(parser), loc, name);
        parser->failed = true;
    }
    else if(is_var)
    {
        ast->type = AST_TYPE_VAR;
        ast->node = make_var(&parser->arena, nullptr, scope, name);
    }
    else
    {
        //FIXME: Print the correct location, this is only a placeholder
        SourceLocation loc;
        error_unresolved_name(parser_source_file(parser), loc, name);
        parser->failed = true;
    }

    if(!is_ambiguous && resolved)
    {
        analyze_ast(parser, ast);
    }
}
